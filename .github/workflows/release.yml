# Release to crates.io and PyPI when a tag vX.Y.Z is pushed.
# Runs build-test on all platforms first; publish and release assets only if all pass.
# Secrets (CRATES_API_KEY, PYPI_API_TOKEN) are in the GitHub environment "Release".

name: Release

on:
  push:
    tags:
      - "v*.*.*"

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build and test on Linux (Ubuntu) â€” release proceeds only if this passes
  build-test:
    name: Build & Test (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x86_64
            runner: ubuntu-22.04
            artifact_name: libgstrtspserversink.so
          - platform: linux-arm64
            runner: ubuntu-22.04-arm
            artifact_name: libgstrtspserversink.so
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install GStreamer
        run: |
          sudo apt-get update
          sudo apt-get install -y libunwind-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --workspace --release
      - name: Test
        run: cargo test --workspace
      - name: Upload GStreamer plugin
        uses: actions/upload-artifact@v4
        with:
          name: gst-rtsp-sink-${{ matrix.platform }}
          path: target/release/${{ matrix.artifact_name }}

  build-wheels:
    name: Wheel (${{ matrix.runner }} Py${{ matrix.python-version }})
    runs-on: ${{ matrix.runner }}
    needs: build-test
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install maturin
      - uses: Swatinem/rust-cache@v2
      - name: Copy README and LICENSE for sdist
        run: cp README.md LICENSE crates/python/
      - name: Build wheel (and sdist on Linux Py3.12 only)
        run: |
          if [ "${{ matrix.runner }}" = "ubuntu-latest" ] && [ "${{ matrix.python-version }}" = "3.12" ]; then
            maturin build -m crates/python/Cargo.toml --release --sdist
          else
            maturin build -m crates/python/Cargo.toml --release
          fi
          mkdir -p dist
          cp target/wheels/*.whl dist/
          if [ "${{ matrix.runner }}" = "ubuntu-latest" ] && [ "${{ matrix.python-version }}" = "3.12" ]; then
            for f in target/wheels/*.tar.gz; do
              [ -f "$f" ] || continue
              dir=$(basename "$f" .tar.gz)
              tarball=$(basename "$f")
              (cd target/wheels && tar -xzf "$tarball" && cp ../../README.md ../../LICENSE "$dir/" && rm -f "$tarball" && tar -czf "$tarball" "$dir" && rm -rf "$dir")
              cp "$f" dist/
              break
            done
          fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.runner }}-py${{ matrix.python-version }}
          path: dist/

  publish:
    name: Publish to crates.io and PyPI
    runs-on: ubuntu-latest
    needs: [build-test, build-wheels]
    environment: Release
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install twine

      - name: Cargo login (crates.io)
        run: echo "${{ secrets.CRATES_API_KEY }}" | cargo login

      - name: Publish rtsp-rs (core) to crates.io
        run: cargo publish -p rtsp-rs --allow-dirty

      - name: Wait for crates.io index
        run: sleep 10

      - name: Download Python wheels and sdist
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - name: Publish rtsp-rs to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*

  # Create GitHub Release and attach GStreamer plugin binaries
  release-assets:
    name: Create release with GStreamer plugins
    runs-on: ubuntu-latest
    needs: build-test
    environment: Release
    permissions:
      contents: write
    steps:
      - name: Download all plugin artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gst-rtsp-sink-*
          path: plugins
          merge-multiple: false

      - name: Rename plugins for release
        run: |
          mkdir -p release-assets
          for dir in plugins/*/; do
            platform=$(basename "$dir" | sed 's/^gst-rtsp-sink-//')
            file=$(find "$dir" -type f | head -1)
            ext="${file##*.}"
            base=$(basename "$file" ".$ext")
            cp "$file" "release-assets/${base}-${platform}.${ext}"
          done
          ls -la release-assets/

      # Pin to v2.4.2 to avoid finalization retry loop in v2.5.x (see softprops/action-gh-release#704)
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
